<div id="projectDetailModal" class="detail-modal">
  <div class="detail-modal-content">
    <span class="close-detail-modal">&times;</span>
    <div class="modal-body">
      <header class="modal-header">
        <h2 id="modalTitle">Project Title</h2>
        <div class="modal-tech-stack" id="modalTechStack"></div>
      </header>

      <div class="modal-scroll-content">
        <section class="modal-section overview">
          <h3 data-i18n="projects.modal.overview">Overview</h3>
          <p id="modalDescription"></p>
          <div id="modalContext" class="context-box"></div>
        </section>

        <!-- Video Section -->
        <section class="modal-section video-section" id="modalVideoSection" style="display: none;">
          <h3 data-i18n="projects.modal.projectVideo">Project Video</h3>
          <div class="video-container" id="modalVideoContainer"></div>
        </section>

        <div class="two-column-grid">
          <section class="modal-section" id="modalChallengesSection">
            <h3 data-i18n="projects.modal.keyChallenges">
              <i class="fas fa-fire-alt"></i> Key Challenges
            </h3>
            <ul id="modalChallenges"></ul>
          </section>

          <section class="modal-section" id="modalSolutionsSection">
            <h3 data-i18n="projects.modal.technicalSolutions">
              <i class="fas fa-check-circle"></i> Technical Solutions
            </h3>
            <ul id="modalSolutions"></ul>
          </section>
        </div>
      </div>

      <footer class="modal-footer">
        <div id="modalLinks" class="modal-links"></div>
      </footer>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const modal = document.getElementById('projectDetailModal');
    const closeBtn = document.querySelector('.close-detail-modal');
    // We need to parse the projects data from the DOM
    const dataContainer = document.getElementById('projects-data');

    if (!dataContainer || !modal || !closeBtn) return;

    const projects = JSON.parse(dataContainer.dataset.projects || '[]');

    const openButtons = document.querySelectorAll('.view-details-btn');

    // Helper function to extract YouTube video ID from URL
    const extractYouTubeId = (url) => {
      if (!url) return null;

      // Handle different YouTube URL formats
      const patterns = [
        /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&\n?#]+)/,
        /^([a-zA-Z0-9_-]{11})$/, // Direct video ID
      ];

      for (const pattern of patterns) {
        const match = url.match(pattern);
        if (match && match[1]) {
          return match[1];
        }
      }

      return null;
    };

    const populateModal = (slug) => {
      const project = projects.find((p) => p.slug === slug);
      if (!project) return;

      const modalTitle = document.getElementById('modalTitle');
      if (modalTitle) modalTitle.textContent = project.title;

      const modalDesc = document.getElementById('modalDescription');
      if (modalDesc) modalDesc.innerHTML = project.description;

      // Tech Stack
      const techContainer = document.getElementById('modalTechStack');
      if (techContainer) {
        techContainer.innerHTML = '';
        project.technologies.forEach((tech) => {
          const span = document.createElement('span');
          span.innerHTML = `${tech.iconClass ? `<i class="${tech.iconClass}"></i> ` : ''}${tech.name}`;
          techContainer.appendChild(span);
        });
      }

      // Detailed Context
      const contextContainer = document.getElementById('modalContext');
      if (contextContainer) {
        if (project.detailedDescription) {
          contextContainer.innerHTML = `<strong>Context & Goal:</strong> ${project.detailedDescription}`;
          contextContainer.style.display = 'block';
        } else {
          contextContainer.style.display = 'none';
        }
      }

      // Video Section with Lazy Loading
      const videoSection = document.getElementById('modalVideoSection');
      const videoContainer = document.getElementById('modalVideoContainer');

      if (videoSection && videoContainer) {
        if (project.videoUrl) {
          // Extract video ID from YouTube URL
          const videoId = extractYouTubeId(project.videoUrl);

          if (videoId) {
            // Create thumbnail with play button (lazy load approach)
            // Video iframe only loads when user clicks play
            videoContainer.innerHTML = `
              <div class="video-thumbnail" data-video-id="${videoId}">
                <img 
                  src="https://img.youtube.com/vi/${videoId}/maxresdefault.jpg" 
                  alt="Video thumbnail"
                  loading="lazy"
                  onerror="this.src='https://img.youtube.com/vi/${videoId}/hqdefault.jpg'"
                />
                <button class="video-play-btn" aria-label="Play video">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M8 5v14l11-7z"/>
                  </svg>
                </button>
              </div>
            `;

            // Add click handler to load video
            const thumbnail = videoContainer.querySelector('.video-thumbnail');

            const loadVideo = (e) => {
              e.preventDefault();
              e.stopPropagation();
              videoContainer.innerHTML = `
                <iframe
                  src="https://www.youtube.com/embed/${videoId}?autoplay=1&enablejsapi=1&rel=0&modestbranding=1"
                  title="Project Video"
                  frameborder="0"
                  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                  allowfullscreen
                ></iframe>
              `;
            };

            if (thumbnail) thumbnail.addEventListener('click', loadVideo);

            videoSection.style.display = 'block';
          } else {
            videoSection.style.display = 'none';
          }
        } else {
          videoSection.style.display = 'none';
        }
      }

      // Challenges
      const challengesList = document.getElementById('modalChallenges');
      const challengesSection = document.getElementById('modalChallengesSection');

      if (challengesList && challengesSection) {
        challengesList.innerHTML = '';
        if (project.challenges && project.challenges.length > 0) {
          project.challenges.forEach((c) => {
            const li = document.createElement('li');
            li.textContent = c;
            challengesList.appendChild(li);
          });
          challengesSection.style.display = 'block';
        } else {
          challengesSection.style.display = 'none';
        }
      }

      // Solutions
      const solutionsList = document.getElementById('modalSolutions');
      const solutionsSection = document.getElementById('modalSolutionsSection');

      if (solutionsList && solutionsSection) {
        solutionsList.innerHTML = '';
        if (project.solutions && project.solutions.length > 0) {
          project.solutions.forEach((s) => {
            const li = document.createElement('li');
            li.textContent = s;
            solutionsList.appendChild(li);
          });
          solutionsSection.style.display = 'block';
        } else {
          solutionsSection.style.display = 'none';
        }
      }

      // Links
      const linksContainer = document.getElementById('modalLinks');
      if (linksContainer) {
        linksContainer.innerHTML = '';
        project.links.forEach((link) => {
          const a = document.createElement('a');
          a.href = link.url;
          a.target = '_blank';
          a.innerHTML = `${link.iconClass ? `<i class="${link.iconClass}"></i> ` : ''}${link.label}`;
          linksContainer.appendChild(a);
        });
      }
    };

    openButtons.forEach((btn) => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation(); // Avoid triggering the global click listeners if any
        const slug = btn.getAttribute('data-slug');
        populateModal(slug);
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
      });
    });

    const closeModal = () => {
      modal.classList.remove('active');
      document.body.style.overflow = '';

      // Stop video playback by clearing the iframe
      // This prevents audio from continuing after modal closes
      const videoContainer = document.getElementById('modalVideoContainer');
      if (videoContainer) {
        videoContainer.innerHTML = '';
      }
    };

    closeBtn.addEventListener('click', closeModal);

    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        closeModal();
      }
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && modal.classList.contains('active')) {
        closeModal();
      }
    });
  });
</script>

<script>
  import en from '../i18n/en.json';
  import es from '../i18n/es.json';

  const translations: any = { en, es };

  function getTranslation(key: string, lang: string) {
    const keys = key.split('.');
    let value: any = translations[lang];
    for (const k of keys) {
      value = value?.[k];
      if (!value && value !== 0) break;
    }
    return value || key;
  }

  function updateModalTranslations() {
    const lang = localStorage.getItem('lang') || 'en';

    // Update all modal headers with data-i18n
    const modalHeaders = document.querySelectorAll('#projectDetailModal [data-i18n]');
    modalHeaders.forEach((header) => {
      const key = header.getAttribute('data-i18n');
      if (key) {
        const translation = getTranslation(key, lang);

        // Check if header has an icon
        if (key === 'projects.modal.keyChallenges') {
          header.innerHTML = `<i class="fas fa-fire-alt"></i> ${translation}`;
        } else if (key === 'projects.modal.technicalSolutions') {
          header.innerHTML = `<i class="fas fa-check-circle"></i> ${translation}`;
        } else {
          header.textContent = translation;
        }
      }
    });

    // Update "Context & Goal:" text if present
    const contextBox = document.getElementById('modalContext');
    if (contextBox && contextBox.innerHTML && contextBox.style.display !== 'none') {
      const contextLabel = getTranslation('projects.modal.contextGoal', lang);
      const description = contextBox.innerHTML.split('</strong> ')[1];
      if (description) {
        contextBox.innerHTML = `<strong>${contextLabel}:</strong> ${description}`;
      }
    }
  }

  document.addEventListener('DOMContentLoaded', updateModalTranslations);
  window.addEventListener('languagechange', updateModalTranslations);
</script>
